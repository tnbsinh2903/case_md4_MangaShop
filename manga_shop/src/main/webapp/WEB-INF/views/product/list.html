<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="utf-8">
    <title>PRODUCT</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="A fully featured admin theme which can be used to build CRM, CMS, etc." name="description">
    <meta content="Coderthemes" name="author">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- App favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico">

    <!-- App css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <link rel="stylesheet" href="/assets/iziToast/v1.4/iziToast.min.css">
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/assets/css/icons.min.css" rel="stylesheet" type="text/css">
    <link href="/assets/css/app.min.css" rel="stylesheet" type="text/css">

    <style>

    </style>
</head>

<body>

<!-- Begin page -->
<div id="wrapper">

    <!-- Topbar Start -->
    <div class="navbar-custom">
        <ul class="list-unstyled topnav-menu float-right mb-0">

            <li class="d-none d-sm-block">
                <form class="app-search">
                    <div class="app-search-box">
                        <div class="input-group">

                            <input type="text" class="form-control" placeholder="Search...">

                            <div class="input-group-append">
                                <button class="btn" type="submit">
                                    <i class="fe-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </li>

            <!-- infor -->

            <li class="dropdown notification-list">
                <a class="nav-link dropdown-toggle nav-user mr-0 waves-effect waves-light" data-toggle="dropdown"
                   href="#" role="button" aria-haspopup="false" aria-expanded="false">
                    <img src="/assets/images/users/avatar-1.jpg" alt="user-image" class="rounded-circle">
                    <span class="pro-user-name ml-1">
                            Nik Patel <i class="mdi mdi-chevron-down"></i>
                        </span>
                </a>
                <div class="dropdown-menu dropdown-menu-right profile-dropdown ">
                    <!-- item-->
                    <div class="dropdown-header noti-title">
                        <h6 class="text-overflow m-0">Welcome !</h6>
                    </div>

                    <!-- item-->
                    <a href="javascript:void(0);" class="dropdown-item notify-item">
                        <i class="remixicon-account-circle-line"></i>
                        <span>My Account</span>
                    </a>


                    <div class="dropdown-divider"></div>

                    <!-- item-->
                    <a href="javascript:void(0);" class="dropdown-item notify-item">
                        <i class="remixicon-logout-box-line"></i>
                        <span>Logout</span>
                    </a>

                </div>
            </li>

        </ul>

        <!-- LOGO -->
        <div class="logo-box">
            <a class="logo text-center">
                    <span class="logo-lg">
                        <img src="/assets/images/logo-light.png" alt="" height="20">
                        <!-- <span class="logo-lg-text-light">Xeria</span> -->
                    </span>
                <span class="logo-sm">
                        <!-- <span class="logo-sm-text-dark">X</span> -->
                        <img src="/assets/images/logo-sm.png" alt="" height="24">
                    </span>
            </a>
        </div>

    </div>
    <!-- end Topbar -->

    <!-- ========== Left Sidebar Start ========== -->
    <div class="left-side-menu bg-dark">

        <div class="slimscroll-menu">

            <!--- Sidemenu -->
            <div id="sidebar-menu">

                <ul class="metismenu" id="side-menu">

                    <li class="menu-title">MANGAGER</li>

                    <li>
                        <a href="#">
                            <i class=" fas fa-user"></i>
                            <span> User </span>
                            <span class="menu-arrow"></span>
                        </a>

                    </li>

                    <li>
                        <a href="javascript: void(0);" class="waves-effect">
                            <i class="fas fa-book"></i>
                            <span> Product </span>
                            <span class="menu-arrow"></span>
                        </a>

                    </li>

                    <li>
                        <a href="javascript: void(0);" class="waves-effect">
                            <i class="fas fa-cart-plus"></i>
                            <span> Order Detail </span>
                            <span class="menu-arrow"></span>
                        </a>

                    </li>


                </ul>

            </div>
            <!-- End Sidebar -->

            <div class="clearfix"></div>

        </div>
        <!-- Sidebar -left -->

    </div>
    <!-- Left Sidebar End -->

    <!-- ============================================================== -->
    <!-- Start Page Content here -->
    <!-- ============================================================== -->

    <div class="content-page">
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">

                <!-- start page title -->
                <div class="row">
                    <div class="col-12">
                        <div class=" page-title-box bg-success">
                            <div class="page-title-right">
                                <a type="button" class=" float-right  btn btn-outline-secondary btn-light create"
                                   data-toggle="modal" data-target="#modalCreateProduct">
                                    <i class="fas fa-plus-square" aria-hidden="true">
                                    </i>
                                    <span>Add New Product</span>
                                </a>
                            </div>
                            <div class="page-title-right mr-3">
                                <a class="btn btn-bordered-primary" href=""><i class="fas fa-shopping-cart"></i></a>
                            </div>
                            <h4 class="page-title">Welcome !</h4>
                        </div>
                    </div>
                </div>
                <!-- end page title -->

                <div class="row">
                    <div class="col-xl-12">
                        <div class="card-box">

                            <h4 class="header-title mb-3">Revenue History</h4>

                            <div class="table-responsive">
                                <input type="hidden" id="currentRow" value="">
                                <table id="tbListProduct" class="table table-borderless table-hover table-centered m-0">

                                    <thead class="thead-light">
                                    <tr class="text-center">
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Image</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Category</th>
                                        <th colspan="3">Action</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div> <!-- end .table-responsive-->
                        </div> <!-- end card-box-->
                    </div> <!-- end col -->
                </div>
                <!-- end row -->
            </div> <!-- container -->
        </div> <!-- content -->

        <!-- Footer Start -->
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-6">
                        2000 - 2022 &copy; <strong class="text-danger">Sink</strong> theme by <a href="">Born
                        Beatiful</a>
                    </div>
                    <div class="col-md-6">
                        <div class="text-md-right footer-links d-none d-sm-block">
                            <a href="javascript:void(0);">About Us</a>
                            <a href="javascript:void(0);">Help</a>
                            <a href="javascript:void(0);">Contact Us</a>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->
    </div>

    <!-- ============================================================== -->
    <!-- End Page content -->
    <!-- ============================================================== -->

</div>

<!--&lt;!&ndash; Vendor js &ndash;&gt;-->
<!--<script src="/assets/js/vendor.min.js"></script>-->
<!--<script src="/assets/libs/jquery-knob/jquery.knob.min.js"></script>-->
<!--<script src="/assets/libs/peity/jquery.peity.min.js"></script>-->
<!--&lt;!&ndash; Sparkline charts &ndash;&gt;-->
<!--<script src="/assets/libs/jquery-sparkline/jquery.sparkline.min.js"></script>-->
<!--&lt;!&ndash; init js &ndash;&gt;-->
<!--<script src="/assets/js/pages/dashboard-1.init.js"></script>-->
<!--&lt;!&ndash; App js &ndash;&gt;-->
<!--<script src="/assets/js/app.min.js"></script>-->
<th:block th:replace="/product/modalCreate :: modelCrate"></th:block>
<th:block th:replace="/product/modalUpdate :: modelUpdate"></th:block>

<th:block th:replace="/script/script :: script"></th:block>
<script src="/assets/js/app.js"></script>

<script>

    let product = new Product();
    let category = new Category();


    function renderProduct(objPro) {
        let str = `
                        <tr class="text-center" id="tr_${objPro.id}">
                            <td>${objPro.id}</td>
                            <td>${objPro.name}</td>
                            <td><img style="height: 50px" src="${objPro.image}" alt="a"/> </td>
                            <td>${new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
        }).format(objPro.price)}</td>
                            <td>${objPro.quantity}</td>
                            <td>${objPro.category.name}</td>
                             <th class="text-center">
                               <a class="btn btn-outline-secondary edit" data-id="${objPro.id}" title="Edit" data-toggle="tooltip" data-toggle="modal"
                                 data-target="#modalUpdateProduct" >
                                  <i class="fas fa-edit" aria-hidden="true"></i>
                               </a>
                            </th>
                            <th class="text-center">
                                <a class="btn btn-outline-success delete"  data-id="${objPro.id}" title="Delete" data-toggle="tooltip" data-toggle="modal" >
                                  <i class="fas fa-ban" aria-hidden="true"></i>
                                </a>
                            </th>
                            <th class="text-center">
                                <a class="btn btn-outline-primary add-cart"  data-id="${objPro.id}" title="Add Cart" data-toggle="tooltip" data-toggle="modal" >
                                  <i class="fas fa-cart-plus" aria-hidden="true"></i>
                                </a>
                            </th>
                        </tr>

                        `;
        return str;
        // $("#tbListCustomers tbody").prepend(str);
    }

    function loadProduct(product) {
        $.ajax({
            headers: {
                'accept': "application/json",
                'Content-Type': "application/json",
            },
            type: 'GET',
            url: "http://localhost:8080/api/products",
            data: JSON.stringify(product)
        })
            .done((data) => {
                data.forEach(item => {
                    product = item;
                    // locationRegion = customer.locationRegion
                    let str = renderProduct(product);
                    $("#tbListProduct tbody").prepend(str);
                });

                App.formatTooltip();
                removeHandleShowModal();
                loadModel();
                // showCreateModal();
                showUpdateProduct();
                // showDepositModal();
                // showWithdrawModal();
                // showTransferModal();
                // showSuspendedModal();
            })
            .fail((jqXHR) => {
                console.log(jqXHR);
            })
    }

    loadProduct()

    function getProductById(productId) {
        return $.ajax({
            headers: {
                'accept': "application/json",
                'content-type': "application/json"
            },
            type: 'GET',
            url: "http://localhost:8080/api/products/" + productId,
        }).done((data) => {
            product = data
        }).fail((jqXHR) => {
            console.log(jqXHR)
        })
    }

    function getAllCategories() {
        return $.ajax({
            headers: {
                'Accept': "application/json",
                'Content-type': 'application/json'
            },
            type: 'GET',
            url: "http://localhost:8080/api/products/category",
            // date :JSON.stringify(category)
        }).done((data) => {
            $("#category").empty();
            $("#categoryUp").empty();

            $.each(data, (i, item) => {
                let str = `
               <option value = '${item.id}'>${item.name}</option>
                `;
                $("#category").append(str)
                $("#categoryUp").append(str)
            })

        })
    }

    getAllCategories();

    $("create").on('click', function () {

        // getAllCategories();
        $("#modalCreateProduct").modal('show')
    });

 function doCreate() {
     // $("#btnCreateProduct").on("click", function () {
         category.id = $('#category').val();
         category.name = $('#category option:selected').text();

         delete product.id;
         product.name = $("#name").val();
         product.image = $("#image").val();
         product.price = $("#price").val();
         product.quantity = $("#quantity").val();
         product.category = category;
         console.log(product)

         $.ajax({
             type: "POST",
             headers: {
                 'Accept': 'application/json',
                 'Content-Type': 'application/json'
             },
             url: "http://localhost:8080/api/products/create",
             data: JSON.stringify(product)
         }).done((data) => {

             let str = renderProduct(data);

             // $("#tbListProduct tbody").prepend(str);
             // let str = `
             //         <tr class="text-center" id="tr_${data.id}">
             //             <td>${data.id}</td>
             //             <td>${data.name}</td>
             //             <td><img style="height: 50px" src="${data.image}" alt="a"/> </td>
             //             <td>${new Intl.NumberFormat('vi-VN', {
             //     style: 'currency',
             //     currency: 'VND'
             // }).format(data.price)}</td>
             //             <td>${data.quantity}</td>
             //             <td>${data.category.name}</td>
             //              <th class="text-center">
             //                <a class="btn btn-outline-secondary edit" data-id="${data.id}" title="Edit" data-toggle="tooltip" data-toggle="modal"
             //                  data-target="#modalUpdateProduct" >
             //                   <i class="fas fa-edit" aria-hidden="true"></i>
             //                </a>
             //             </th>
             //             <th class="text-center">
             //                 <a class="btn btn-outline-success delete"  data-id="${data.id}" title="Delete" data-toggle="tooltip" data-toggle="modal" >
             //                   <i class="fas fa-ban" aria-hidden="true"></i>
             //                 </a>
             //             </th>
             //             <th class="text-center">
             //                 <a class="btn btn-outline-primary add-cart"  data-id="${data.id}" title="Add Cart" data-toggle="tooltip" data-toggle="modal" >
             //                   <i class="fas fa-cart-plus" aria-hidden="true"></i>
             //                 </a>
             //             </th>
             //         </tr>
             //
             //         `;
             $("#tbListProduct tbody").prepend(str);

             App.IziToast.showSuccessAlert("Create Product Successful !");
             App.formatTooltip();
             loadModel();

             $('#modalCreateProduct').modal('hide');

         }).fail((jqXHR) => {
             // let str = "";
             if (jqXHR.responseJSON) {
                 $.each(jqXHR.responseJSON, function (key, item) {
                     //         str += `<ul>
                     //         <li>
                     //    <label id="${key}-error" class="error" for="${key}">${item}</label>
                     //     </li>
                     //      </ul>`;
                     //         $("#" + key).addClass("error");
                     App.showErrorAlert(item)
                 });
             }
             // $("#modalCreateProduct .modal-alert-danger").empty().removeClass("hide").addClass("show").append(str);
             console.log(jqXHR)
         });

     // });
 }

    // $("#modalCreateProduct").on("hidden.bs.modal", function () {
    //     $('#frmCreateProduct')[0].reset();
    // })

    $("#modalCreateProduct").on("hidden.bs.modal", function () {
        $("#modalCreateProduct .modal-alert-danger").empty();
        $("#frmCreateProduct")[0].reset();
        $("#frmCreateProduct").validate().resetForm();
        $('#modalCreateProduct .modal-alert-danger').removeClass('show').addClass('hide');
    });

    $("#btnCreateProduct").on("click", function () {
        $('#modalCreateProduct .modal-alert-danger').removeClass('show').addClass('hide');
        $("#modalCreateProduct .modal-alert-danger").empty();
        $('#frmCreateProduct').submit();
    })

    $('#frmCreateProduct').validate({
        rules: {
            name: {
                required: true,
                minlength: 3,
                maxlength: 50
            },
            image: {
                required: true,
                // maxlength: 255
            },
            quantity: {
                required: true,
                min: 0,
                max: 1000
            },
            price: {
                required: true,
                min: 0,
                max: 10000000
            }
        },
        messages: {
            name: {
                required: "Vui lòng nhập tên sản phẩm !",
                minlength: "Tên sản phẩm tên tối thiểu 5 ký tự",
                maxlength: "Tên sản phẩm tối đa 50 ký tự"
            },
            image: {
                required: "Vui lòng điền link ảnh sẳn phảm !",
            },
            quantity: {
                required: "Vui lòng nhập số lượng !",
                min: "Số lượng tối thiểu 1 ",
                max: "Số lượng tối đa 1000"
            },
            price: {
                required: "Vui lòng nhập giá !",
                min: "Giá sản phẩm phải lớn hơn 0đ !",
                max: "Giá sản phẩm tối đa 10.000.000đ !"
            }
        },
        onkeyup: function (element) {
            $(element).valid()
        },
        onclick: false,
        onfocusout: false,
        errorLabelContainer: "#modalCreateProduct .modal-alert-danger",
        errorPlacement: function (error, element) {
            App.showErrorAlert(element)
            error.appendTo("#modalUpdateProduct .modal-alert-danger");
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalCreateProduct .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalCreateProduct .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmCreateProduct input.error").removeClass("error");
            }
             this.defaultShowErrors();
        },
        submitHandler: function () {
            doCreate();
        }
    });

    function showUpdateProduct() {
        $(".edit").on('click', function () {
            let productId = $(this).data("id");

            getProductById(productId).then(() => {
                console.log(category)
                $("#productId").val(productId);
                $("#nameUp").val(product.name);
                $("#imageUp").val(product.image);
                $("#priceUp").val(product.price);
                $("#quantityUp").val(product.quantity);
                $("#categoryUp").val(product.category.id);


                $("#modalUpdateProduct").modal('show');
            // }).catch(() => {
            //     alert("error")
            })
        })
    }

 function doUpdate() {
     // $("#btnUpdateProduct").on('click', function () {

         category.id = $('#categoryUp').val();
         category.name = $('#categoryUp option:selected').text();

         product.name = $("#nameUp").val();
         product.image = $("#imageUp").val();
         product.price = $("#priceUp").val();
         product.quantity = $("#quantityUp").val();
         product.category = category;

         $.ajax({
             headers: {
                 'accept': "application/json",
                 'content-type': "application/json"
             },
             type: 'PUT',
             url: "http://localhost:8080/api/products/update",
             data: JSON.stringify(product)
         }).done((date) => {
             product = date;

             let str = renderProduct(product);
             $("#tr_" + product.id).replaceWith(str);

             removeHandleShowModal();
             loadModel();
             App.IziToast.showSuccessAlert("Data update successful !");

             $("#modalUpdateProduct").modal('hide');

         }).fail((jqXHR) => {
             console.log(jqXHR)
         })
     // })
 }

    $("#modalUpdateProduct").on("hidden.bs.modal", function () {
        $("#modalUpdateProduct .modal-alert-danger").empty();
        $("#frmUpdateProduct")[0].reset();
        $("#frmUpdateProduct").validate().resetForm();
        $('#modalUpdateProduct .modal-alert-danger').removeClass('show').addClass('hide');
    });

    $("#btnUpdateProduct").on("click", function () {
        $('#modalUpdateProduct .modal-alert-danger').removeClass('show').addClass('hide');
        $("#modalUpdateProduct .modal-alert-danger").empty();
        $('#frmUpdateProduct').submit();
    })

    $('#frmUpdateProduct').validate({
        rules: {
            nameUp: {
                required: true,
                minlength: 3,
                maxlength: 50
            },
            imageUp: {
                required: true,
                // maxlength: 255
            },
            quantityUp: {
                required: true,
                min: 0,
                max: 1000
            },
            priceUp: {
                required: true,
                min: 0,
                max: 10000000
            }
        },
        messages: {
            nameUp: {
                required: "Vui lòng nhập tên sản phẩm !",
                minlength: "Tên sản phẩm tên tối thiểu 5 ký tự",
                maxlength: "Tên sản phẩm tối đa 50 ký tự"
            },
            imageUp: {
                required: "Vui lòng điền link ảnh truyện !",
            },
            quantityUp: {
                required: "Vui lòng nhập số lượng !",
                min: "Số lượng tối thiểu 1 ",
                max: "Số lượng tối đa 1000"
            },
            priceUp: {
                required: "Vui lòng nhập giá !",
                min: "Giá sản phẩm phải lớn hơn 0đ!",
                max: "Giá sản phẩm tối đa 10.000.000đ!"
            }
        },
        onkeyup: function (element) {
            $(element).valid()
        },
        onclick: false,
        onfocusout: false,
        errorLabelContainer: "#modalCreateProduct .modal-alert-danger",
        errorPlacement: function (error, element) {
            App.showErrorAlert(element)
            error.appendTo("#modalUpdateProduct .modal-alert-danger");
        },
        showErrors: function (errorMap, errorList) {
            if (this.numberOfInvalids() > 0) {
                $("#modalCreateProduct .modal-alert-danger").removeClass("hide").addClass("show");
            } else {
                $("#modalCreateProduct .modal-alert-danger").removeClass("show").addClass("hide").empty();
                $("#frmCreateProduct input.error").removeClass("error");
            }
            this.defaultShowErrors();
        },
        submitHandler: function () {
            doUpdate();
        }
    });

    $("#tbListProduct").on("click", ".delete", function () {
        product.id = $(this).data('id');
        $("#currentRow").val($(this).closest("tr").attr("id"));
        showSuspendedModal();
    });

    function showSuspendedModal() {

        let productId = product.id;
        console.log(productId);
        App.showSuspendedConfirmDialog()
            .then((result) => {
                if (result.isConfirmed) {

                    doDelete(productId);
                }
            });

    }

    function doDelete(productId) {
        console.log(productId)
        $.ajax({
            type: "DELETE",
            headers: {
                'accept': "application/json",
                'content-type': "application/json"
            },
            url: "http://localhost:8080/api/products/delete/" + productId,
            data: JSON.stringify(productId)
        }).done((data) => {

            $("#tr_" + productId).remove();

            removeHandleShowModal();
            loadModel();
            iziToast.success({
                title: 'OK',
                position: 'topRight',
                timeout: 2100,
                message: "Delete Date Successfully !"
            });
            // App.IziToast.showSuccessAlert("Delete Date Successfully !");

        }).fail(() => {
            App.showErrorAlert("An error occurred. Please try again later!");

        })
    }

    function removeHandleShowModal() {
        $(".edit").off("click");
        $(".delete").off("click");
    }

    function loadModel() {
        showUpdateProduct();
        // doCreate();
        // showSuspendedModal();
    }
</script>

</body>

</html>